# Development Log - December 1, 2025

## Session Start: 2025-12-01

---

## 10:30 AM - Preserve Traceback Animation on Re-clicks

### Branch
`main`

### Related Files
- `index.html` (lines 2321-2339, 2858-2880)

### Context
Working on improving the traceback animation UX. Previously, when a node was clicked to trigger the traceback animation (showing upstream teachers in yellow and downstream students in blue), clicking on another node that was already part of the highlighted trajectory would re-trigger the entire animation, causing a distracting flicker effect.

### Issue/Problem
Users exploring a lineage trajectory would experience unnecessary re-animation when clicking nodes already in the active traceback path. This created a jarring visual experience and made it harder to navigate through the highlighted lineage.

### What We Tried
**Approach 1: Detect if clicked node is already in trajectory**
- Added logic in `dragended()` click handler to check `tracebackActive && tracedNodes.has(d.id)`
- If node is already traced, skip full traceback and only update popup + zoom
- Result: ‚úÖ Success - animation now persists smoothly

**Approach 2: Create dedicated zoom function for single nodes**
- Implemented `zoomToSingleNode()` function (lines 2858-2880)
- Zooms to 1.5x scale with 750ms smooth transition
- Centers the clicked node in viewport
- Result: ‚úÖ Success - smooth navigation within trajectory

### Implementation Details

**1. Modified Click Handler (index.html:2321-2339)**
```javascript
if (tracebackActive && tracedNodes.has(d.id)) {
    console.log("Node already in traceback - preserving animation, updating popup and zooming");
    updatePopup(d);
    zoomToSingleNode(d);
    return; // Skip full traceback
}
```

**2. New Zoom Function (index.html:2858-2880)**
```javascript
function zoomToSingleNode(node) {
    if (!node || !node.x || !node.y) return;

    const scale = 1.5;
    const x = -node.x * scale + window.innerWidth / 2;
    const y = -node.y * scale + window.innerHeight / 2;

    svg.transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity
            .translate(x, y)
            .scale(scale)
        );

    console.log("Zoomed to single node:", node.data["Name_English"]);
}
```

### Current Status
‚úÖ **Implementation Complete** - Feature is fully functional and ready for testing.

### Expected Behavior
1. **First click (any node)** ‚Üí Full traceback animation with yellow upstream + blue downstream
2. **Click node in active trajectory** ‚Üí No re-animation, just popup update + smooth zoom
3. **Click node outside trajectory** ‚Üí New full traceback animation starts

### Results/Findings
- Console logging added for debugging:
  - "Node already in traceback - preserving animation, updating popup and zooming"
  - "New node - triggering full traceback"
  - "Zoomed to single node: [name]"
- Improved UX by eliminating unnecessary animation flicker
- Maintains smooth navigation within lineage exploration

### Next Steps
- [x] Test in browser with various node click sequences
- [ ] Verify behavior with all three lineages (Vairocana, Vimalamitra, Padmasambhava)
- [ ] Check edge cases (orphan nodes, nodes with many connections)
- [ ] User testing to confirm improved navigation experience

---

## 3:08 PM - Upstream Animation Direction Bug (Persistent Issue)

### Branch
`main`

### Related Files
- `index.html` (lines 2160-2165, 3026-3032, 3066-3101)

### Context
While implementing the preserve-traceback feature, discovered a persistent bug with the yellow upstream flow animation. The blue downstream animations work perfectly, but the yellow upstream flow is glitchy and flows in the wrong direction.

### Issue/Problem
**Desired behavior:** Yellow animation should flow **upward** from clicked node toward ancestors (Padmasambhava, etc.)

**Actual behavior:** Yellow animation flows in a "botched" manner - overall heading toward ancestors, but at each step tracing downstream (appearing to flow from ancestors down to clicked node, which is backwards).

### Root Cause Analysis
SVG `<line>` elements are drawn with coordinates:
```javascript
linkElements
    .attr('x1', d => d.source.x)  // ancestor (higher up)
    .attr('y1', d => d.source.y)
    .attr('x2', d => d.target.x)  // descendant (lower down)
    .attr('y2', d => d.target.y);
```

All links point **downward** (source‚Üítarget, ancestor‚Üídescendant).

When `stroke-dashoffset` animates from `lineLength` to `0`, it reveals the line in its natural direction (downward), which is correct for downstream but **backwards for upstream**.

### What We Tried

**Attempt 1: Reverse stroke-dashoffset animation for upstream**
- Changed upstream to animate from `0` to `-lineLength` (index.html:3028-3032)
- Expected to make line appear to flow backward (upward)
- Result: ‚ùå **Still broken** - animations remain glitchy

```javascript
// Attempted fix (did not work)
.style('stroke-dashoffset', direction === 'upstream' ? 0 : lineLength)
.transition()
.style('stroke-dashoffset', direction === 'upstream' ? -lineLength : 0)
```

### Current Status
üî¥ **Blocked** - Upstream animation still not working correctly after attempted fix.

### Decisions Made
- **Scrap current flowing line animation implementation entirely**
- **Rebuild from scratch** with proper directional logic
- Keep blue downstream animations (they work perfectly)
- Focus only on fixing yellow upstream animations

### Technical Approach for Rebuild
Need to fundamentally change how upstream animations work:

**Option 1: Swap line coordinates for upstream**
- Temporarily reverse x1/y1 and x2/y2 for upstream links
- This makes the SVG line naturally point upward
- Then standard dashoffset animation will flow upward

**Option 2: Use SVG path instead of line**
- Convert upstream links to `<path>` elements
- Paths allow explicit direction control
- Can draw path from target‚Üísource for upstream

**Option 3: Particle-only animation**
- Remove stroke-dashoffset animation for upstream entirely
- Rely only on flowing particles (which already work correctly per createFlowingParticle)
- Simpler and potentially more reliable

### Next Steps
- [ ] Analyze which approach is most reliable
- [ ] Implement rebuild of upstream animation
- [ ] Test that yellow flow moves upward from clicked node to ancestors
- [ ] Verify particles and line highlights are synchronized
- [ ] Ensure no regression in downstream (blue) animations

---

## 3:37 PM - Negative Offset Approach Failed - Complete Rebuild Required

### Branch
`main`

### Related Files
- `index.html` (lines 3027-3096)

### Context
After the previous coordinate-swapping approach failed, attempted a cleaner solution using negative `stroke-dashoffset` to reverse the animation direction. Theory was that animating from `-lineLength ‚Üí 0` would reveal the line from end‚Üístart (upward flow).

### What We Tried

**Attempt 2: Negative stroke-dashoffset approach**
- Changed upstream animation: `.style('stroke-dashoffset', -lineLength)` then animate to `0`
- Expected: Line would reveal from end to start (upward)
- Removed all coordinate swapping logic
- Removed particle effects entirely (per user request)
- Simplified code significantly (~35 lines removed)

**Code implemented:**
```javascript
} else {
    // Upstream: Use negative stroke-dashoffset to reverse animation direction
    linkElement
        .style('stroke-dasharray', lineLength)
        .style('stroke-dashoffset', -lineLength)  // Negative = reverse direction
        .transition()
        .duration(200)
        .ease(d3.easeLinear)
        .style('stroke-dashoffset', 0)
        .on('end', function() {
            // Restore dash patterns...
        });
}
```

### Result
‚ùå **FAILED** - Upstream yellow animation is STILL BROKEN

- Blue downstream animation continues working perfectly ‚úÖ
- Yellow upstream animation does not flow upward as expected ‚ùå
- Negative offset approach does not achieve the desired visual effect

### Root Cause Analysis (Updated)
The fundamental issue is **NOT just about dashoffset direction**. The problem is more complex:

1. SVG lines are **physical geometric objects** drawn from source‚Üítarget
2. `stroke-dashoffset` controls **where the dash pattern starts**, not the **direction of reveal**
3. Whether offset is positive or negative, the line still reveals along the **same geometric path** (source‚Üítarget)
4. Negative offset just shifts the dash pattern starting point, it doesn't reverse the animation flow direction

**Why downstream works:**
- Line drawn: source (top) ‚Üí target (bottom)
- Animation reveals: source ‚Üí target (downward) ‚úÖ
- Visual flow matches geometric direction ‚úÖ

**Why upstream fails:**
- Line drawn: source (bottom) ‚Üí target (top)  ‚Üê WAIT, this is wrong
- Actually: Line drawn: source (ancestor/top) ‚Üí target (descendant/bottom)
- We want animation to reveal: target ‚Üí source (upward)
- But dashoffset (positive or negative) always reveals along the line's natural direction (downward)
- **There is no dashoffset trick that can reverse the geometric reveal direction**

### Decisions Made
1. **Scrap dashoffset animation entirely for upstream**
2. **Rebuild from scratch** using a completely different technique
3. **Must fundamentally change how upstream links are animated**, not just parameter tweaks

### Possible Rebuild Approaches

**Option A: Coordinate Swap with .attr() (not .style())**
- Use `.attr('x1', ...)` to actually change line coordinates
- Temporarily pause/stop force simulation during animation
- Swap coordinates so line points upward (target‚Üísource)
- Animate dashoffset normally (will now flow upward)
- Restore coordinates after animation

**Option B: Dual-element rendering**
- Keep original lines as-is
- During animation, create temporary `<line>` elements with reversed coordinates
- Animate these temporary lines (which point upward)
- Remove temporary elements after animation completes

**Option C: SVG clip-path or mask animation**
- Don't use dashoffset at all
- Animate a clip-path or mask that reveals the line progressively
- Can control direction by animating mask from bottom‚Üítop for upstream

**Option D: Gradient-based reveal**
- Replace dashoffset with animated gradient
- Gradient opacity goes from transparent‚Üíopaque
- Control gradient direction to flow upward/downward

### Next Steps
- [ ] Choose most reliable rebuild approach
- [ ] Implement complete rebuild of upstream animation
- [ ] Test extensively before considering it fixed
- [ ] Document why dashoffset fundamentally cannot work for this use case

---
